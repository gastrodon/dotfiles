name: Build NixOS System

on:
  push:
    branches: [ main, copilot/create-nix-module-documentation ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-24.05
          extra_nix_config: |
            experimental-features = nix-command flakes
      
      - name: Set up Cachix (optional - for caching builds)
        uses: cachix/cachix-action@v12
        with:
          name: nixos-build
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
          skipPush: true  # Set to false if you have CACHIX_AUTH_TOKEN configured
      
      - name: Build NixOS system configuration
        run: |
          echo "Building NixOS system derivation..."
          
          # Build the system configuration
          # We use nix-build to build the system derivation without installing it
          nix-build '<nixpkgs/nixos>' \
            -A system \
            -I nixos-config=./configuration.nix \
            -I nixpkgs=channel:nixos-24.05 \
            --show-trace \
            --option allow-import-from-derivation true
          
          # Check the result
          ls -lh result/
          
          echo "Build successful! System derivation created."
      
      - name: Check system closure size
        run: |
          echo "Calculating system closure size..."
          nix-store -qR result | wc -l | xargs echo "Number of dependencies:"
          du -sh result/ | awk '{print "Closure size:", $1}'
      
      - name: Verify configuration syntax
        run: |
          echo "Verifying Nix configuration syntax..."
          nix-instantiate --parse ./configuration.nix > /dev/null
          nix-instantiate --parse ./hardware-configuration.nix > /dev/null
          for module in ./module/*.nix; do
            echo "Checking $module"
            nix-instantiate --parse "$module" > /dev/null
          done
          echo "All configuration files have valid syntax!"
      
      - name: Build summary
        if: always()
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -L result ]; then
            echo "✅ NixOS system built successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### System Information" >> $GITHUB_STEP_SUMMARY
            echo "- **Derivation**: $(readlink result)" >> $GITHUB_STEP_SUMMARY
            echo "- **Dependencies**: $(nix-store -qR result | wc -l)" >> $GITHUB_STEP_SUMMARY
            echo "- **Size**: $(du -sh result/ | awk '{print $1}')" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Build failed" >> $GITHUB_STEP_SUMMARY
          fi
